<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Boxplots</title>
    <link href="PSet5-B-solution.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v5.js"></script>
  </head>

	<body>
		<div id="main">
      <div id="chartPanel">
  			<h3>Create a boxplot</h3>
  			<p>Click in the center of the blue strip to add points.</p>
        <div id="clickActionChooser">
          <span>
            <label>
              <input type="radio" name="clickAction" value="add" checked>
              Add points
            </label>
          </span>

          <span>
            <label>
              <input type="radio" name="clickAction" value="remove">
              Remove points
            </label>
          </span>
        </div>
        <div id="boxplotBox">
          <div>
            <svg id="boxplot" width="200px" height="400px" xmlns="http://www.w3.org/2000/svg">
            </svg>
          </div>
        </div>
  		</div>

  		<div id="statsPanel">
  			<h3>How to Read a Boxplot</h3>
  			<div class="statsBox">
          <div class="stat"><div class="statLabel">Data values:</div><div class="statValues" id="dataValues"></div></div>
          <div class="stat"><div class="statLabel">Outliers:</div><div class="statValues" id="outliers"></div></div>
          <div class="stat"><div class="statLabel">Upper whisker:</div><div class="statValues" id="upperWhisker"></div></div>
          <div class="stat"><div class="statLabel">Q3:</div><div class="statValues" id="q3"></div></div>
          <div class="stat"><div class="statLabel">Median:</div><div class="statValues" id="median"></div></div>
          <div class="stat"><div class="statLabel">Q1:</div><div class="statValues" id="q1"></div></div>
          <div class="stat"><div class="statLabel">Lower whisker:</div><div class="statValues" id="lowerWhister"></div></div>
        </div>
  		</div>
		</div>

<script type="text/javascript">

const targetAreaHeight = 380;

const svg = d3.select('svg#boxplot')
const svgRect = svg.node().getBoundingClientRect()
const plotHeight = svgRect.height - 20

// this rect to mark the boundaries of the svg
svg.append('rect')
  .attr('x', 0)
  .attr('y', 0)
  .attr('height', '100%')
  .attr('width', '100%')
  .attr('stroke', 'blue')
  .attr('fill', 'none')

// mainGroup contains y axis and the target area with the boxplot
const mainGroup = svg
  .append('g')
  .attr('transform', 'translate(0, 10)') // move it slightly so that the labels of the axis are not clipped

// draw y axis here
const yAxis = mainGroup
  .append('rect')
  .attr('x', 10)
  .attr('y', 0)
  .attr('height', plotHeight)
  .attr('width', 20)
  .attr('fill', 'lightgreen')

// draw target clicking area and handle click events
const targetArea = mainGroup
.append('g')
.attr('transform', 'translate(60, 0)')

targetArea
.append('rect')
.attr('x', 0)
.attr('y', 0)
.attr('height', plotHeight)
.attr('width', 100)
.attr('fill', '#D1EEF1')

const yScale = d3.scaleLinear()
    .domain([-100, 100])
    .range([plotHeight, 0])

const calculateStats = (data) => {
  const sorted = data.sort()
  const q1 = d3.quantile(sorted, 0.25)
  const median = d3.median(sorted)
  const q3 = d3.quantile(sorted, 0.75)
  const upperWhisker = q3 + (q3-q1)*1.5;
  const lowerWhister = q1 - (q3-q1)*1.5
  const isOutlier = (d) => (d <= lowerWhister) || (d >= upperWhisker)
  const outliers = sorted.filter(isOutlier)
  return {
    data,
    isOutlier, // this is a function
    outliers,
    upperWhisker,
    q3,
    median,
    q1,
    lowerWhister
  }
}

const calculateClosestValue = (data, value) => {
  return data.reduce((acc, d) => {
    return Math.abs(value - d) < acc.diff ? {value: d, diff: Math.abs(value - d)} : acc
  }, {value, diff: 10000}).value
}

const updateElements = () => {
  const circles = targetArea.selectAll('circle')
  const data = circles.data()
  const stats = calculateStats(data)
  const toString = (d) => d.toString()
  circles.attr('fill', (d) => stats.isOutlier(d) ? 'red' : 'black')

  if (data.length > 0) {
    // update values of stats
    d3.select('#dataValues').text(data.map(toString).join(', '))
    d3.select('#outliers').text(stats.outliers.map(toString).join(', '))
    d3.select('#upperWhisker').text(toString(stats.upperWhisker))
    d3.select('#q3').text(toString(stats.q3))
    d3.select('#median').text(toString(stats.median))
    d3.select('#q1').text(toString(stats.q1))
    d3.select('#lowerWhister').text(toString(stats.lowerWhister))
  } else {
    // No data passed, blank out stats display
    d3.select('#dataValues').text('')
    d3.select('#outliers').text('')
    d3.select('#upperWhisker').text('')
    d3.select('#q3').text('')
    d3.select('#median').text('')
    d3.select('#q1').text('')
    d3.select('#lowerWhister').text('')
  }
}

targetArea
.append('rect')
.attr('x', 25)
.attr('y', 0)
.attr('height', plotHeight)
.attr('width', 50)
.attr('fill', '#BAE3EA')
.on('click', (d, i, nodes) => {
  const point = d3.mouse(targetArea.node())
  const value = Math.round(yScale.invert(point[1]))
  if (d3.select('input[name="clickAction"]:checked').node().value === 'add') {
    targetArea.append('circle')
      .attr('cx', point[0])
      .attr('cy', point[1])
      .attr('r', 3)
      .datum(value)
  } else {
    const closestValue = calculateClosestValue(targetArea.selectAll('circle').data(), value)
    targetArea.selectAll('circle').filter((d) => d === closestValue).filter((d, i) => i===0).remove()
  }
  updateElements()
})

updateElements()

</script>

	</body>

</html>
